<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SFTP Client</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg:#111418; --panel:#1c2026; --panel-border:rgba(255,255,255,.06);
            --text:#e5e7eb; --muted:#9aa3af; --accent:#3b82f6;
            --radius:10px; --shadow:0 10px 30px rgba(0,0,0,.45); --gap:clamp(1rem,2.5vw,2rem);
        }
        *{box-sizing:border-box}
        html,body{height:100%; margin:0}
        body{
            color:var(--text);
            background:
                    radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.03), transparent),
                    radial-gradient(1000px 700px at 80% 90%, rgba(255,255,255,.02), transparent),
                    var(--bg);
            font:16px/1.5 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; letter-spacing:.2px;
        }

        header.topbar{
            position:fixed; inset:0 0 auto 0; height:60px; background:rgba(28,32,38,.9);
            border-bottom:1px solid rgba(255,255,255,.08); backdrop-filter:blur(8px);
            display:flex; align-items:center; justify-content:space-between; padding:0 2rem; z-index:10;
        }
        header.topbar h1{margin:0; font-size:1.2rem; font-weight:800}
        .topbar form{margin:0}
        .topbar button{
            background:#374151; color:#fff; border:none; border-radius:8px; font-weight:600; padding:.5rem 1rem; cursor:pointer;
            transition:background .25s ease, transform .1s ease, box-shadow .25s ease;
        }
        .topbar button:hover{background:var(--accent); box-shadow:0 0 6px rgba(59,130,246,.4); transform:translateY(-1px)}

        main.wrap{min-height:100dvh; padding:calc(60px + 4vh) 5vw 5vh;}
        .center{width:min(1300px,100%); margin:0 auto;}

        .card{
            background:var(--panel); border:1px solid var(--panel-border); border-radius:var(--radius);
            padding:clamp(1rem,2.5vw,2rem); box-shadow:var(--shadow);
            display:grid; gap:1rem; overflow:hidden; min-height:60vh;
            transition:transform .2s, box-shadow .2s, border-color .2s;
        }
        .card:hover{transform:translateY(-1px); box-shadow:0 16px 40px rgba(0,0,0,.55); border-color:rgba(59,130,246,.25)}
        .card-header{display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap}
        .left, .right{display:flex; align-items:center; gap:.5rem}

        .breadcrumbs{
            display:flex; align-items:center; gap:.4rem; font-weight:600;
            background:#0e1116; border:1px solid rgba(255,255,255,.08); border-radius:8px; padding:.45rem .7rem;
            white-space:nowrap; overflow:auto; max-width:60vw;
        }
        .breadcrumbs a{color:var(--text); text-decoration:none; opacity:.95}
        .breadcrumbs a:hover{color:var(--accent)}
        .crumb-sep{opacity:.4}

        .status{display:flex; align-items:center; gap:.75rem; min-height:32px;}
        .error{color:#fecaca; background:#7f1d1d; border:1px solid rgba(254,202,202,.35); padding:.35rem .55rem; border-radius:8px; display:none}
        .spinner{display:none; font-weight:700; opacity:.9}
        .spinner::after{content:"Loading…";}

        .btn{background:#374151; color:#fff; border:1px solid transparent; border-radius:8px; font-weight:600; padding:.55rem .9rem; cursor:pointer}
        .btn:hover{background:var(--accent); border-color:rgba(59,130,246,.5); box-shadow:0 0 6px rgba(59,130,246,.4); transform:translateY(-1px); transition:background .25s, transform .1s, box-shadow .25s, border-color .25s}
        .btn.secondary{background:transparent; border:1px solid rgba(255,255,255,.12); color:var(--text)}
        .btn.icon{padding:.5rem .6rem; display:inline-grid; place-items:center}
        .search{display:flex; align-items:center; gap:.5rem; background:#0e1116; border:1px solid rgba(255,255,255,.08); border-radius:8px; padding:.45rem .6rem;}
        .search input{background:transparent; border:none; color:var(--text); outline:none; min-width:220px;}

        .pane{background:#0e1116; border:1px solid rgba(255,255,255,.08); border-radius:10px; overflow:auto;}
        table.files{width:100%; border-collapse:separate; border-spacing:0}
        table.files thead th{
            position:sticky; top:0; background:#0f1318; z-index:1;
            text-align:left; font-size:.9rem; color:var(--muted); padding:.8rem 1rem; border-bottom:1px solid rgba(255,255,255,.06); user-select:none;
        }
        table.files tbody td{padding:.85rem 1rem; border-bottom:1px solid rgba(255,255,255,.06); vertical-align:middle}
        tr:hover td{background:rgba(255,255,255,.02)}
        .name-cell{display:flex; align-items:center; gap:.6rem; min-width:240px}
        .badge{font-size:.75rem; color:#cbd5e1; background:rgba(59,130,246,.15); border:1px solid rgba(59,130,246,.35); padding:.15rem .45rem; border-radius:999px}
        .muted{color:var(--muted)}
        .note{font-size:.9rem; color:var(--muted); opacity:.85}
        .ico{width:18px; height:18px; opacity:.85}

        @media (max-width:720px){
            .search input{min-width:120px}
            .hide-sm{display:none}
            .breadcrumbs{max-width:100%}
        }
    </style>
</head>
<body>

<header class="topbar">
    <h1>SFTP Client</h1>
    <form th:action="@{/logout}" method="post">
        <button type="submit">Logout</button>
    </form>
</header>

<main class="wrap">
    <div class="center">
        <section class="card" aria-labelledby="browser-title">
            <div class="card-header">
                <div class="left">
                    <div id="path" class="breadcrumbs" aria-label="Breadcrumb"></div>
                    <button class="btn icon" id="btn-up" title="Up one level" aria-label="Go up">
                        <!-- Lucide arrow-up -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="ico" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m18 15-6-6-6 6"/>
                        </svg>
                    </button>
                    <button class="btn icon" id="btn-refresh" title="Refresh" aria-label="Refresh">
                        <!-- Lucide refresh-ccw -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="ico" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 2v6h-6"/>
                            <path d="M3 12a9 9 0 0 1 9-9 9 9 0 0 1 9 9"/>
                            <path d="M3 22v-6h6"/>
                            <path d="M21 12a9 9 0 0 1-9 9 9 9 0 0 1-9-9"/>
                        </svg>
                    </button>
                </div>
                <div class="right">
                    <button class="btn secondary" disabled>New folder</button>
                    <button class="btn" disabled>Upload…</button>
                    <div class="search">
                        <svg class="ico" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.5"/><path d="M20 20l-3-3" stroke="currentColor" stroke-width="1.5"/></svg>
                        <input type="search" id="q" placeholder="Search files…" aria-label="Search files" disabled>
                    </div>
                    <div class="status">
                        <span id="loading" class="spinner" aria-live="polite"></span>
                        <span id="error" class="error" role="alert"></span>
                    </div>
                </div>
            </div>

            <div class="pane" role="region" aria-label="File list">
                <table class="files">
                    <thead>
                    <tr>
                        <th style="width:46%;">Name</th>
                        <th class="hide-sm" style="width:18%;">Type</th>
                        <th class="hide-sm" style="width:18%;">Size</th>
                        <th style="width:18%;">Modified</th>
                    </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>

        </section>
    </div>
</main>

<script>
    const $ = sel => document.querySelector(sel);

    function joinPath(a, b) {
        if (!a) return b || "";
        if (!b) return a;
        return (a.replace(/\/+$/,'') + '/' + b.replace(/^\/+/, '')).replace(/\/+/g,'/');
    }

    function parentPath(p) {
        if (!p) return "";
        const parts = p.split('/').filter(Boolean);
        parts.pop();
        return parts.join('/');
    }

    function setQuery(path) {
        const url = new URL(window.location);
        if (path) url.searchParams.set('selectedDir', path);
        else url.searchParams.delete('selectedDir');
        history.pushState({path}, '', url);
    }

    function getQueryPath() {
        return new URL(location.href).searchParams.get('selectedDir') || '';
    }

    function formatBytes(n) {
        if (n == null) return '';
        const u = ['B','KB','MB','GB','TB'];
        let i = 0, x = Number(n);
        while (x >= 1024 && i < u.length-1) { x /= 1024; i++; }
        return x.toFixed(x >= 10 || i===0 ? 0 : 1) + ' ' + u[i];
    }

    function extFromName(name){
        const m = (name || '').match(/\.([^.]+)$/);
        return m ? m[1].toLowerCase() : '';
    }

    function renderBreadcrumb(path) {
        const container = $('#path');
        const parts = path ? path.split('/').filter(Boolean) : [];
        let acc = '';
        const segs = [`<span class="crumb"><a href="#" data-path="">/</a></span>`];
        parts.forEach((p) => {
            acc = joinPath(acc, p);
            segs.push(`<span class="crumb-sep">/</span><span class="crumb"><a href="#" data-path="${acc}">${p}</a></span>`);
        });
        container.innerHTML = segs.join('');

        container.querySelectorAll('a[data-path]').forEach(a => {
            a.addEventListener('click', (e) => {
                e.preventDefault();
                load(a.dataset.path);
            });
        });
        $('#btn-up').onclick = () => {
            const up = parentPath(path);
            if (up !== path) load(up);
        };
    }

    async function fetchDir(path) {
        const err = $('#error');
        const spinner = $('#loading');
        err.style.display = 'none';
        err.textContent = '';
        spinner.style.display = 'inline';
        try {
            const res = await fetch(`/api/dirs?selectedDir=${encodeURIComponent(path)}`, {cache:'no-store'});
            const data = await res.json();
            if (!Array.isArray(data)) {
                throw new Error(data && data.error ? data.error : 'Unexpected response');
            }
            return data;
        } finally {
            spinner.style.display = 'none';
        }
    }

    function renderTable(currentPath, items) {
        const tbody = $('#tbody');
        if (!items.length) {
            tbody.innerHTML = `<tr><td colspan="4" class="muted" style="padding:1.2rem 1rem; text-align:center; opacity:.8;">Empty</td></tr>`;
            return;
        }
        items.sort((a,b) => {
            if (a.type !== b.type) return a.type === 'folder' ? -1 : 1;
            return a.name.localeCompare(b.name, undefined, {sensitivity:'base'});
        });
        const rows = [];
        for (const it of items) {
            const isFolder = it.type === 'folder';
            const when = it.lastModified ? new Date(it.lastModified).toLocaleString() : '';
            const size = isFolder ? '—' : formatBytes(it.size);
            const typeLabel = isFolder ? 'Directory' : (extFromName(it.name) || 'File');
            const iconFolder = `<svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M3 7a2 2 0 012-2h4l2 2h6a2 2 0 012 2v7a2 2 0 01-2 2H5a2 2 0 01-2-2V7z" fill="currentColor"/></svg>`;
            const iconFile = `<svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M6 2h7l5 5v13a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2z" stroke="currentColor" stroke-width="1.3" fill="none"/><path d="M13 2v5h5" stroke="currentColor" stroke-width="1.3" fill="none"/></svg>`;
            const nameCell = isFolder
                ? `<div class="name-cell">${iconFolder}<button class="btn secondary btn-open" data-path="${it.path}" style="padding:.2rem .5rem;">${it.name}</button> <span class="badge">folder</span></div>`
                : `<div class="name-cell">${iconFile}<span>${it.name}</span></div>`;
            rows.push(`
        <tr>
          <td>${nameCell}</td>
          <td class="hide-sm muted">${typeLabel}</td>
          <td class="hide-sm muted">${size}</td>
          <td class="muted">${when}</td>
        </tr>
      `);
        }
        tbody.innerHTML = rows.join('');
        tbody.querySelectorAll('.btn-open[data-path]').forEach(btn => {
            btn.addEventListener('click', () => load(btn.dataset.path));
        });
    }

    async function load(path) {
        try {
            setQuery(path);
            renderBreadcrumb(path);
            const data = await fetchDir(path);
            renderTable(path, data);
        } catch (e) {
            const err = $('#error');
            err.textContent = e && e.message ? e.message : 'Failed to load';
            err.style.display = 'inline-block';
            $('#tbody').innerHTML = '';
        }
    }

    $('#btn-refresh').onclick = () => load(getQueryPath());
    window.addEventListener('popstate', () => load(getQueryPath()));
    load(getQueryPath());
</script>

</body>
</html>
