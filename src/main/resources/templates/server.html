<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Spring + Thymeleaf + SFTP</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg:#111418;
            --panel:#1c2026;
            --panel-border:rgba(255,255,255,.06);
            --text:#e5e7eb;
            --muted:#9aa3af;
            --accent:#3b82f6;       /* blue used only on hover/focus */
            --radius:8px;
            --gap:clamp(1.25rem,3vw,3rem);
            --shadow:0 10px 30px rgba(0,0,0,.45);
        }

        *{box-sizing:border-box}
        html,body{height:100%; margin:0}

        body{
            color:var(--text);
            background:
                    radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.03), transparent),
                    radial-gradient(1000px 700px at 80% 90%, rgba(255,255,255,.02), transparent),
                    var(--bg);
            font:16px/1.5 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
            letter-spacing:.2px;
        }

        /* Topbar */
        header.topbar{
            position:fixed; inset:0 0 auto 0; height:60px; background:rgba(28,32,38,.9);
            backdrop-filter:blur(8px); border-bottom:1px solid rgba(255,255,255,.08);
            display:flex; align-items:center; justify-content:space-between; padding:0 2rem; z-index:10;
        }
        .topbar .user{font-weight:600}
        .topbar form{margin:0}
        .topbar button{
            background:#374151; /* neutral base */
            color:#fff; border:none; font-weight:600; border-radius:6px; padding:.5rem 1rem; cursor:pointer;
            transition:background .25s ease, transform .1s ease, box-shadow .25s ease, border-color .25s ease;
        }
        .topbar button:hover{
            background:var(--accent);
            box-shadow:0 0 6px rgba(59,130,246,.4); /* subtle blue glow */
            transform:translateY(-1px);
        }

        /* Layout */
        main.wrap{min-height:100dvh; display:grid; place-items:center; padding:calc(60px + 5vh) 5vw 5vh;}
        .grid{width:min(1200px,100%); display:grid; grid-template-columns:1fr auto 1.25fr; gap:var(--gap); align-items:stretch;}
        .left{display:grid; gap:var(--gap);}

        /* Cards */
        .card{
            background:var(--panel); border:1px solid var(--panel-border); border-radius:var(--radius);
            padding:clamp(1.25rem,3.5vw,2.75rem); box-shadow:var(--shadow); display:grid; align-content:start; gap:1rem;
            transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
        }
        .card:hover{
            transform:translateY(-2px);
            box-shadow:0 16px 40px rgba(0,0,0,.55);
            border-color:rgba(59,130,246,.25); /* faint blue tint */
        }

        /* Headings / text */
        h2{
            margin:0 0 .25rem; font-size:clamp(1.15rem,2.8vw,1.6rem); font-weight:800; color:var(--text);
        }
        .muted{color:var(--muted); margin:0}
        .ok{color:#34d399} .warn{color:#f59e0b}
        .hidden{display:none}

        /* Divider */
        .divider{
            width:1px; position:relative; opacity:.9;
            background:linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(59,130,246,.25) 30%, rgba(59,130,246,.25) 70%, rgba(255,255,255,0) 100%);
        }
        .divider::before{content:""; position:absolute; inset:0; box-shadow:0 0 20px 6px rgba(59,130,246,.12)}

        /* Forms / Inputs */
        form{display:grid; gap:.75rem}
        .inline-actions{display:flex; gap:.5rem; flex-wrap:wrap}

        input{
            background:#0e1116; border:1px solid rgba(255,255,255,.08); border-radius:6px;
            padding:.6rem .9rem; color:var(--text); font-size:1rem;
            transition:border-color .2s ease, box-shadow .2s ease;
        }
        input:focus{
            outline:none; border-color:var(--accent); box-shadow:0 0 5px rgba(59,130,246,.25);
        }

        /* Buttons */
        button{
            background:#374151; /* neutral base */
            color:#fff; border:1px solid transparent; font-weight:600; border-radius:6px; padding:.65rem 1rem; cursor:pointer;
            transition:background .25s ease, transform .1s ease, box-shadow .25s ease, border-color .25s ease;
            width:fit-content;
        }
        button:hover{
            background:var(--accent); /* blue on hover */
            border-color:rgba(59,130,246,.5);
            box-shadow:0 0 6px rgba(59,130,246,.4); /* subtle glow */
            transform:translateY(-1px);
        }

        .btn-secondary{
            background:transparent; border:1px solid rgba(255,255,255,.12); color:var(--text); border-radius:6px;
        }
        .btn-secondary:hover{
            border-color:rgba(59,130,246,.5);
            box-shadow:0 0 5px rgba(59,130,246,.2);
            color:#fff;
        }

        .icon-btn{width:32px; height:32px; display:grid; place-items:center; font-weight:800; font-size:1.1rem; line-height:1; padding:0;}

        /* Log box */
        .logbox{
            margin-top:.25rem; background:#0e1116; border:1px solid rgba(255,255,255,.06); border-radius:6px;
            padding:1rem; min-height:320px; max-height:60vh; overflow:auto;
            font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
            font-size:.92rem; color:#cbd5e1;
        }

        /* Responsive */
        @media (max-width:960px){
            .grid{grid-template-columns:1fr; gap:calc(var(--gap)*.8)}
            .divider{
                height:1px; width:100%;
                background:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(59,130,246,.25) 30%, rgba(59,130,246,.25) 70%, rgba(255,255,255,0) 100%);
            }
            .divider::before{box-shadow:0 0 18px 5px rgba(59,130,246,.12)}
        }
    </style>
</head>
<body>

<header class="topbar">
    <div class="user">Logged in as <strong th:text="${username}">admin</strong></div>
    <form th:action="@{/logout}" method="post">
        <button type="submit">Logout</button>
    </form>
</header>

<main class="wrap">
    <div class="grid" role="group" aria-label="SFTP layout">
        <div class="left">

            <!-- SFTP Server -->
            <section class="card" aria-labelledby="srv-title">
                <h2 id="srv-title">SFTP Server</h2>
                <button id="toggleSftpBtn" class="btn-secondary" type="button" onclick="toggleSftp()">Manage SFTP</button>

                <div id="sftpDetails" class="hidden">
                    <p class="muted" th:if="${message}" th:text="${message}">Welcome.</p>
                    <p class="muted">Status:
                        <strong th:text="${sftpRunning} ? 'Running' : 'Stopped'"
                                th:classappend="${sftpRunning} ? ' ok' : ' warn'">Stopped</strong>
                    </p>
                    <div class="inline-actions">
                        <form th:action="@{/start-server}" method="post" th:if="${!sftpRunning}">
                            <input type="password" name="password" placeholder="Enter Password" required>
                            <button type="submit">Start SFTP</button>
                        </form>
                        <form th:action="@{/stop-server}" method="post" th:if="${sftpRunning}">
                            <button type="submit">Stop SFTP</button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Users (collapsible) -->
            <section class="card" aria-labelledby="users-title">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <h2 id="users-title" style="margin:0">Users</h2>
                    <button
                            id="usersToggle"
                            class="btn-secondary icon-btn"
                            type="button"
                            aria-expanded="false"
                            aria-controls="usersPanel"
                            onclick="toggleUsers()">
                        <span id="usersToggleIcon" aria-hidden="true">+</span>
                    </button>
                </div>

                <div id="usersPanel" class="">
                    <p class="muted">Connected SFTP users.</p>

                    <div id="users" aria-live="polite" style="display:grid; gap:.5rem">
                        <div class="muted" id="users-empty" style="opacity:.9">No connected users.</div>
                    </div>

                    <div id="users-error" class="muted" style="color:#f87171; display:none;"></div>

                    <div class="inline-actions" style="margin-top:.5rem">
                        <button id="users-refresh" type="button" class="btn-secondary">Refresh</button>
                    </div>
                </div>
            </section>

            <!-- Directories -->
            <section class="card" aria-labelledby="dirs-title">
                <h2 id="dirs-title">Directories</h2>
                <p class="muted">Map or view user directories here.</p>
                <form onsubmit="event.preventDefault()">
                    <input type="text" placeholder="e.g. /data/uploads">
                    <div class="inline-actions">
                        <button type="submit">Add Directory</button>
                        <button type="button" class="btn-secondary">Refresh</button>
                    </div>
                </form>
                <div class="muted" style="opacity:.9">No directories yet.</div>
            </section>
        </div>

        <div class="divider" aria-hidden="true"></div>

        <!-- Logs -->
        <section class="card" aria-labelledby="logs-title" style="min-height:520px;">
            <h2 id="logs-title">Logs</h2>
            <p class="muted">Live server output or recent actions will appear here.</p>
            <div class="logbox" id="logbox">
                [00:00:01] System ready.
                [00:00:05] Waiting for SFTP server start...
                [00:00:12] (placeholder) Stream logs here.
            </div>
        </section>
    </div>
</main>

<script th:inline="javascript">
    window.ACTIVE_URL = /*[[@{/sessions/active}]]*/ '/sessions/active';
</script>

<script th:src="@{/js/sftp-users.js(v=${#dates.createNow().time})}" defer></script>

<script>
    function toggleSftp(){
        const details = document.getElementById('sftpDetails');
        const btn = document.getElementById('toggleSftpBtn');
        details.classList.toggle('hidden');
        btn.textContent = details.classList.contains('hidden') ? 'Manage SFTP' : 'Hide SFTP Controls';
    }

    let usersPoll = null;

    function toggleUsers(){
        const panel = document.getElementById('usersPanel');
        const btn = document.getElementById('usersToggle');
        const icon = document.getElementById('usersToggleIcon');

        const willOpen = panel.classList.contains('hidden');
        panel.classList.toggle('hidden');
        btn.setAttribute('aria-expanded', String(willOpen));
        icon.textContent = willOpen ? '−' : '+';

        if (willOpen) {
            loadUsers?.();
            if (usersPoll) clearInterval(usersPoll);
            usersPoll = setInterval(() => loadUsers?.(), 5000);
        } else {
            if (usersPoll) { clearInterval(usersPoll); usersPoll = null; }
        }
    }
</script>
</body>
</html>
